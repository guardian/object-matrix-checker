# ObjectMatrixChecker

Simple app to check free space on Object Matrix vaults and report it to ElasticSearch

It's intended to work alongside other scripts that scrape the output of `df` hence the slightly odd data format

## Publishing

The built app is published at https://cloud.docker.com/u/guardianmultimedia/repository/docker/guardianmultimedia/object-matrix-checker.

The quickest way to get hold of it is to head over there, check the 'latest' tag and run it in Docker as shown below.

## Usage

You need to supply a .vault file for each vault that you want to check.
.vault files are generated by the Matrix Store Admin app when setting
up vaults or users and provide the internal IDs, IP addresses and credentials necessary to access a Vault.

Set the following environment variables, if any are not set they all have default values:
- **VAULT_INFORMATION_PATH** - directory containing the .vault files, one for each vault to examine. Any file ending in
'.vault' in this directory will be loaded in as a vault file. Defaults to `/etc/vaults`
- **ELASTICSEARCH_URL** - URL that ElasticSearch can be found at. Defaults to http://localhost:9200.
- **INDEX_NAME** - the index to write to. Defaults to "diskspace".
- **SLEEP_TIME_MINUTES** - time to wait between checks. Defaults to 5 minutes.

Then simply run the app.

It's simplest to do this in Docker:

```
docker run --rm -v ${VAULTS_PATH}:/etc/vaults -e ELASTICSEARCH_URL=http://elasticsearch:9200 -e SLEEP_TIME_MINUTES=10 guardianmultimedia/object-matrix-checker:DEV
```

The app won't terminate by itself, use `docker stop` or CTRL-C to end it.

## Kubernetes deployment

Have a look at the `example-deployment/` directory.
This contains sample Kubernetes manifests to deploy the scanner - a single Deployment (you shouldn't need to scale it beyond 1)
and a secrets manifest to hold the vault credentials.

Simply update `vault-credentials.yaml` by listing the filename under `data` (ensuring it still ends with .vault) and pasting the base64-encoded content of your 
.vault file into the manifest, and update `omspace-deploy` to point to your elasticsearch deployment
(this must, obviously, be visible from within the container)

You can then just deploy the manifests: `kubectl apply -f .`

## Development

If you want to play with the code, then it is simple enough to just clone this repository and run `sbt docker:publishLocal`
to get your own docker image.  The only requirements are sbt and/or an integrated editor.
There is a handy script in the `utils` directory that fires up a local Elasticsearch instance on port 9200 for development - 
it creates a directory `esdata` to persist contents between runs. `esdata` is safe to delete whenever the instance is not running.
Obviously this requires that you have Docker installed on your development machine.